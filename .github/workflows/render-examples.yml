name: Render D2 Examples

on:
  push:
    branches: [ main ]
    paths:
      - 'examples/**'
      - 'styles/**'
      - '.github/workflows/render-examples.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'examples/**'
      - 'styles/**'
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install D2
      run: |
        curl -fsSL https://d2lang.com/install.sh | sh -s -- --version v0.6.7
        sudo mv bin/d2 /usr/local/bin/
    
    - name: Create output directory
      run: mkdir -p rendered-examples
    
    - name: Render D2 examples to SVG
      run: |
        set -e
        shopt -s nullglob
        files=(examples/*.d2)
        if [ ${#files[@]} -eq 0 ]; then
          echo "Error: No .d2 files found in examples directory"
          exit 1
        fi
        for file in "${files[@]}"; do
          filename=$(basename "$file" .d2)
          echo "Rendering $file to rendered-examples/${filename}.svg"
          d2 "$file" "rendered-examples/${filename}.svg"
        done
    
    - name: Upload rendered examples as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: rendered-examples
        path: rendered-examples/
        retention-days: 90
        if-no-files-found: error
